<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= article.title %> | MyBlog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- crucial for phones -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body class="bg-light">
  <style>
    .article-img {
      width: 100%;   
      height: 400px;
      object-fit: cover;
      padding:10px;
      border-radius: 20px;
    }
  </style>

  <%- include('partials/navbar.ejs') %>

  <div class="container-md my-4"> <!-- container-md keeps narrow width on desktop, fluid on mobile -->

    <!-- Article Section -->
    <div class="card shadow-lg border-0 mb-4">
      <div class="card-body p-3 p-md-4">
        
        <!-- Title + Buttons -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-3">
          <h1 class="card-title fw-bold text-primary mb-0 fs-3 fs-md-1"><%= article.title %></h1>

          <% if(currentUser && article.author.equals(currentUser)) { %>
          <div class="d-flex gap-2">
            <form action="<%= `/article/edit/${article._id}` %>" method="GET">
              <button type="submit" class="btn btn-outline-primary btn-sm w-100 w-md-auto">
                <i class="bi bi-pencil"></i> <span class="d-none d-md-inline">Edit</span>
              </button>
            </form>
            <form action="<%= `/article/${article._id}?_method=delete` %>" method="POST">
              <button type="submit" class="btn btn-outline-danger btn-sm w-100 w-md-auto">
                <i class="bi bi-trash"></i> <span class="d-none d-md-inline">Delete</span>
              </button>
            </form>
          </div>
          <% } %>
        </div>

        <!-- Meta Info -->
        <div class="mb-3 d-flex flex-wrap gap-2">
          <span class="badge bg-secondary">
            <i class="bi bi-calendar-event"></i> <%= article.createdAt.toDateString() %>
          </span>
          <span class="badge bg-info text-dark">
            <i class="bi bi-person-circle"></i> <%= article.author.username %>
          </span>
          <small class="text-muted">(<%= article.author.email %>)</small>
        </div>
        <hr>
        <img src="<%= article.image.path %>" class="img-fluid rounded article-img " alt="Article Image">
        <p class="card-text fs-6 fs-md-5 lh-lg"><%= article.body %></p>
      </div>
    </div>
     <!-- Add Comment / Login -->
    <% if(currentUser) { %>
    <div class="card shadow-sm mt-4 border-0">
      <div class="card-body p-3">
        <h5 class="card-title text-success mb-3">
          <i class="bi bi-pencil-square"></i> Add a Comment
        </h5>
        <form action="/article/<%= article._id %>/comments" method="POST">
          <div class="mb-3">
            <textarea class="form-control" name="body" rows="3" placeholder="What are your thoughts?" required></textarea>
          </div>
          <button type="submit" class="btn btn-success w-100 w-md-auto">
            <i class="bi bi-send"></i> Comment
          </button>
        </form>
      </div>
    </div>
    <% } else { %>
    <div class="card shadow-sm mt-4 border-0">
      <div class="card-body p-3">
        <h5 class="card-title text-muted mb-3">
          <i class="bi bi-box-arrow-in-right"></i> Login to Comment
        </h5>
        <form action="/users/login" method="get">
          <button type="submit" class="btn btn-primary w-100 w-lg-auto">Login</button>
        </form>
      </div>
    </div>
    <% } %>

    <!-- Comments Section -->
    <div class="card shadow-sm border-0">
      <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
        <div>
          <i class="bi bi-chat-left-text"></i> Comments
        </div>
        <% if(article.comments.length > 1){ %>
          <form action="<%=`/article/${article._id}`%>" method="GET" class="mb-0">
            <input type="hidden" name="commentSortOrder" value="<%=nextSortingOrder%>">
            <button type="submit" class="btn btn-outline-light btn-sm">
              <%= buttonValue %>
            </button>
          </form>
        <% } %>
      </div>
      <div class="card-body p-3">
        <% if(article.comments.length === 0) { %>
          <p class="text-muted fst-italic">No comments yet. Be the first to comment!</p>
        <% } else { %>
         <ul class="list-group list-group-flush">
  <% article.comments.forEach(comment => { %>
    <li class="list-group-item py-3">
      <!-- Row: Username + Body on left, Buttons on right -->
      <div class="d-flex justify-content-between align-items-start">
        
        <!-- Left side -->
        <div>
          <div class="fw-semibold text-primary">
            <i class="bi bi-person-fill "></i> <%= comment.author.username %>
          </div>
          <div class ="text-muted small">
            <i class="bi bi-clock-fill small"></i>
            <%= comment.createdAt?.toDateString() %>
          </div>
          <div class="text-bold large"><%= comment.body %></div>
        </div>

        <!-- Right side: Buttons -->
        <% if(currentUser && comment.author.equals(currentUser)) { %>
          <div class="d-flex gap-2 ms-3">
            <!-- Edit Button -->
            <button 
              class="btn btn-outline-primary btn-sm toggle-edit-form" 
              data-id="<%= comment._id %>">
              <i class="bi bi-pencil"></i>
            </button>

            <!-- Delete Button -->
            <form action="/article/<%= article._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST">
              <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </div>
        <% } %>
      </div>

      <!-- Hidden Inline Edit Form (below the row) -->
      <% if(currentUser && comment.author.equals(currentUser)) { %>
      <form 
        id="edit-form-<%= comment._id %>" 
        action="/article/<%= article._id %>/comments/<%= comment._id %>?_method=PATCH" 
        method="POST" 
        class="edit-form d-none mt-2">
        
        <div class="mb-2">
          <textarea name="body" class="form-control" rows="2"><%= comment.body %></textarea>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success btn-sm">
            <i class="bi bi-check2"></i> Save
          </button>
          <button type="button" class="btn btn-secondary btn-sm cancel-edit" data-id="<%= comment._id %>">
            Cancel
          </button>
        </div>
      </form>
      <% } %>
    </li>
  <% }) %>
</ul>
        <% } %>
      </div>
    </div>

   

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".toggle-edit-form").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        document.getElementById(`edit-form-${id}`).classList.remove("d-none");
        btn.style.display = "none"; // hide edit button when form is visible
      });
    });

    document.querySelectorAll(".cancel-edit").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        document.getElementById(`edit-form-${id}`).classList.add("d-none");
        document.querySelector(`.toggle-edit-form[data-id="${id}"]`).style.display = "inline-block";
      });
    });
  });
</script>
</body>
</html>